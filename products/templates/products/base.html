import unittest
import socket
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager

class TradingAppTest(unittest.TestCase):
    @classmethod
    def setUpClass(cls):
        try:
            # Verify server connection first
            cls.verify_server_connection()
            
            # Setup WebDriver
            chrome_service = Service(ChromeDriverManager().install())
            cls.driver = webdriver.Chrome(service=chrome_service)
            cls.driver.implicitly_wait(5)
            cls.base_url = "http://localhost:8000"
            cls.wait = WebDriverWait(cls.driver, 10)
            
            # Test user credentials (must exist in your database)
            cls.test_user = {
                'username': 'testuser',
                'password': 'Testpass123!',
                'email': 'testuser@example.com'
            }
        except Exception as e:
            print(f"\nCRITICAL SETUP ERROR: {str(e)}")
            raise

    @classmethod
    def verify_server_connection(cls):
        """Check if server is running before tests"""
        try:
            sock = socket.create_connection(('localhost', 8000), timeout=5)
            sock.close()
            print("✓ Server is running on port 8000")
        except Exception as e:
            raise Exception(f"Server not running at localhost:8000 - {str(e)}")

    def test_0_connection(self):
        """Verify basic server response"""
        print("\nTesting server connection...")
        try:
            self.driver.get(self.base_url)
            print(f"Current URL: {self.driver.current_url}")
            print(f"Page title: {self.driver.title}")
            print(f"Page source snippet: {self.driver.page_source[:500]}...")
            self.assertTrue(self.driver.title, "Page title is empty")
            print("✓ Basic connection established")
        except Exception as e:
            self.fail(f"Connection failed: {str(e)}")

    def test_1_homepage_load(self):
        """Flexible homepage test"""
        print("\nTesting homepage...")
        try:
            self.driver.get(self.base_url)
            
            # Wait for any content
            self.wait.until(
                EC.presence_of_element_located((By.XPATH, "//*[text()]"))
            )
            
            # Verify basic content
            body_text = self.driver.find_element(By.TAG_NAME, "body").text
            self.assertTrue(len(body_text) > 0, "Page has no content")
            print(f"Page content: {body_text[:100]}...")
            print("✓ Homepage loaded with content")
        except Exception as e:
            self.driver.save_screenshot("homepage_error.png")
            self.fail(f"Homepage failed: {str(e)}\nCurrent URL: {self.driver.current_url}")

    def test_2_signup(self):
        """Flexible signup test"""
        print("\nTesting signup...")
        try:
            self.driver.get(f"{self.base_url}/signup")
            
            # Debug output
            print("\nPage source snippet:")
            print(self.driver.page_source[:1000])
            
            # Generate test data
            timestamp = str(int(time.time()))
            test_data = {
                'username': f"testuser{timestamp}",
                'email': f"test{timestamp}@example.com",
                'password': "Testpass123!"
            }
            
            # Field mapping with fallbacks
            field_map = {
                'username': ['id_username', 'name=username', 'input[type="text"]'],
                'email': ['id_email', 'name=email'],
                'password1': ['id_password1', 'name=password1'],
                'password2': ['id_password2', 'name=password2']
            }
            
            # Fill form with flexible selectors
            for field, selectors in field_map.items():
                element = None
                for selector in selectors:
                    try:
                        if selector.startswith('id_'):
                            element = self.driver.find_element(By.ID, selector[3:])
                        elif selector.startswith('name='):
                            element = self.driver.find_element(By.NAME, selector[5:])
                        else:
                            element = self.driver.find_element(By.CSS_SELECTOR, selector)
                        element.send_keys(test_data.get(field.replace('1', ''), ''))
                        break
                    except:
                        continue
                
                if not element:
                    self.fail(f"Could not find {field} field")
            
            # Submit form
            submit_buttons = [
                "//button[contains(., 'Sign Up')]",
                "//button[contains(., 'Register')]",
                "//input[@type='submit']"
            ]
            
            for button in submit_buttons:
                try:
                    self.driver.find_element(By.XPATH, button).click()
                    break
                except:
                    continue
            else:
                self.fail("Could not find submit button")
            
            # Verify success
            try:
                self.wait.until(EC.any_of(
                    EC.url_contains("dashboard"),
                    EC.presence_of_element_located((By.CSS_SELECTOR, ".alert-success")),
                    EC.title_contains("Welcome")
                ))
                print("✓ Signup successful")
            except TimeoutException:
                errors = self.driver.find_elements(By.CSS_SELECTOR, ".error, .alert-danger")
                if errors:
                    self.fail(f"Signup errors: {[e.text for e in errors]}")
                self.driver.save_screenshot("signup_error.png")
                self.fail("Signup success not detected")
                
        except Exception as e:
            self.driver.save_screenshot("signup_failure.png")
            self.fail(f"Signup failed: {str(e)}")

    @classmethod
    def tearDownClass(cls):
        if hasattr(cls, 'driver'):
            cls.driver.quit()

if __name__ == "__main__":
    unittest.main()